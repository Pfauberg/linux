# Отчет об инциденте: Проблема с доступом к веб-сайту

## Дата инцидента
7 января 2025 года

## Дата отчета
11 января 2025 года

## Автор
John Pfauberg

---

## Описание инцидента
Веб-сайт по адресу https://3.79.39.74 перестал работать. При попытке посетить сайт выводилось сообщение об ошибке:

```
$wgServer must be set in LocalSettings.php. See https://www.mediawiki.org/wiki/Manual:$wgServer
```

Это указывало на проблему с конфигурацией сервера.

---

## Причина инцидента
Первопричиной инцидента стало переполнение логов веб-сервера, что привело к отсутствию свободного дискового пространства на сервере. Также, в конфигурационном файле `LocalSettings.php`, расположенном по правильному пути `/var/www/html/mediawiki/`, файл оказался пустым. При этом файл `LocalSettings (5).php`, использованный для замены пустого файла, содержал некорректный адрес веб-сервера.

---

## Шаги по устранению проблемы

### 1. Первичная диагностика
- При попытке перейти на сайт выводилось сообщение об ошибке, связанное с конфигурацией. Было принято решение подключиться к серверу для дальнейшего анализа.

### 2. SSH подключение и права доступа
- При попытке подключения к серверу через SSH возникла ошибка:
  ```
  igor@igor-ThinkPad-T480:~$ ssh -i /home/igor/ich/ich.pem ec2-user@3.79.39.74
  @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
  @         WARNING: UNPROTECTED PRIVATE KEY FILE!          @
  @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
  Permissions 0664 for '/home/igor/ich/ich.pem' are too open.
  It is required that your private key files are NOT accessible by others.
  This private key will be ignored.
  Load key "/home/igor/ich/ich.pem": bad permissions
  ec2-user@3.79.39.74: Permission denied (publickey,gssapi-keyex,gssapi-with-mic).
  ```
- Проблема была связанна с правами и решена командой:
  ```bash
  chmod 600 /home/igor/ich/ich.pem
  ```
- После этого подключение к серверу прошло успешно.

### 3. Проверка статуса демона веб-сервера
- После успешного подключения к серверу была выполнена команда для проверки статуса демона веб-сервера:
  ```bash
  sudo service httpd status
  ```
  - Вывод команды показал, что веб-сервер работает корректно:
    ```
    Redirecting to /bin/systemctl status httpd.service
    ● httpd.service - The Apache HTTP Server
       Loaded: loaded (/usr/lib/systemd/system/httpd.service; enabled; vendor preset: disabled)
      Drop-In: /usr/lib/systemd/system/httpd.service.d
               └─php-fpm.conf
       Active: active (running) since пон 2025-01-06 09:38:36 UTC; 22h ago
         Docs: man:httpd.service(8)
     Main PID: 2074 (httpd)
       Status: "Total requests: 227; Idle/Busy workers 90/10;Requests/sec: 0.00278; Bytes served/sec:   2 B/sec"
       CGroup: /system.slice/httpd.service
               ├─ 2074 /usr/sbin/httpd -DFOREGROUND
               ├─ 2264 /usr/sbin/httpd -DFOREGROUND
               ├─ 2270 /usr/sbin/httpd -DFOREGROUND
               ├─ 2642 /usr/sbin/httpd -DFOREGROUND
               ├─ 3090 /usr/sbin/httpd -DFOREGROUND
               ├─10778 /usr/sbin/httpd -DFOREGROUND
               ├─19772 /usr/sbin/httpd -DFOREGROUND
               ├─19773 /usr/sbin/httpd -DFOREGROUND
               ├─19786 /usr/sbin/httpd -DFOREGROUND
               ├─19796 /usr/sbin/httpd -DFOREGROUND
               └─19802 /usr/sbin/httpd -DFOREGROUND
    ```
- Вывод в терминале подтвердил, что Apache веб-сервер работает, и предстоят дальнейшие действия по проверкам и исправлению проблемы.

### 4. Поиск конфигурационного файла LocalSettings.php
- В ходе диагностики была предпринята попытка найти файл `LocalSettings.php`, указанный в ошибке. Для этого были выполнены следующие шаги:
  - Сначала команда `ls` выявила наличие файла `LocalSettings (5).php` (вероятно одна из резервных копий файла) в домашней директории пользователя:
    ```bash
    [ec2-user@ip-10-0-41-237 ~]$ ls
    credentials  LocalSettings (5).php
    ```
  - Затем выполнен поиск файла:
    ```bash
    sudo find / -type f -name "LocalSettings.php"
    ```
    - Вывод показал расположение файла в директории MediaWiki:
    ```
      /var/www/html/mediawiki/LocalSettings.php
    ```
  - Однако при попытке вывести содержание файла, он оказался пуст. Поэтому было решено вернуться к файлу `LocalSettings (5).php`, найденному ранее с помощью команды `ls`.

### 5. Попытка открыть файл LocalSettings (5).php
- При попытке вывести содержимое файла `LocalSettings (5).php` через команду `cat` была получена ошибка:
  ```bash
  [ec2-user@ip-10-0-41-237 ~]$ cat LocalSettings\ (5).php
  -bash: cannot create temp file for here-document: No space left on device
  ```
- Это указывало на полное отсутствие свободного места на сервере, что препятствовало чтению содержимого файла и выполнению других операций.

### 6. Решение проблемы с отсутствием места
- Для подтверждения проблемы с дисковым пространством была выполнена команда `df -h`:
  ```bash
  [ec2-user@ip-10-0-41-237 ~]$ df -h
  Файловая система Размер Использовано  Дост Использовано% Cмонтировано в
  devtmpfs           1,9G            0  1,9G            0% /dev
  tmpfs              1,9G            0  1,9G            0% /dev/shm
  tmpfs              1,9G          65M  1,9G            4% /run
  tmpfs              1,9G            0  1,9G            0% /sys/fs/cgroup
  /dev/nvme0n1p1      10G          10G   20K          100% /
  tmpfs              389M            0  389M            0% /run/user/1000
  ```
  - Вывод показал, что основной раздел сервера полностью заполнен.
- Выполнен поиск больших файлов:
  ```bash
  sudo find / -type f -size +1G
  ```
  - Найден большой файл лога веб-сервера:
    ```
    /var/log/httpd/access_log
    ```
- Лог-файл был очищен командой:
  ```bash
  sudo truncate -s 0 /var/log/httpd/access_log
  ```
- После выполнения команды дисковое пространство было освобождено, что позволило продолжить работу с конфигурационным файлом.

### 7. Исправление ошибки в файле LocalSettings (5).php
- После освобождения дискового пространства файл `LocalSettings (5).php` был перенесен командой `cp` по нужному пути `/var/www/html/mediawiki/LocalSettings.php` и успешно открыт.
- При анализе содержимого файла обнаружена строка с неправильным адресом:
  ```php
  $wgServer = "https://18.153.51.162";
  ```
- Адрес был исправлен на корректный, и веб-сайт https://3.79.39.74 заработал вновь.

### 8. Создание скрипта для очистки логов
- Для предотвращения повторной проблемы с нехваткой места был создан скрипт `log_backup.sh` для очистки логов.
- Задача в `crontab`, архивировавшая логи каждую минуту, была заменена на запуск скрипта с помощью команды:
  ```bash
  sudo crontab -e
  ```
  - Новая строка задачи:
    ```
    0 0 * * * /home/ec2-user/log_backup.sh
    ```
- Скрипту были наданы права на исполнение и настроена задача на ежедневное выполнение для автоматизации процесса очистки и предотвращения переполнения места на сервере.

---

## Результаты
- Веб-сайт был восстановлен.
- Проблема с нехваткой места на сервере была временно устранена за счет очистки логов и настройки скрипта автоматической очистки.
- Долгосрочные меры по предотвращению повторения инцидента еще не внедрены и требуют улучшений.

---

## Рекомендации

### 1. Расширенный мониторинг и алертинг
- Установить инструмент мониторинга, с интеграцией уведомлений через email, Slack или Telegram, чтобы предупреждать о возможных проблемах с дисковым пространством, загрузкой сервера и состоянием ключевых сервисов.

### 2. Автоматизация очистки/хранения логов
- Настроить инструмент управления логами для автоматической ротации и удаления старых логов.
- Включить сжатие архивов для экономии места.

### 3. Система резервного копирования
- Внедрить централизованное решение для резервного копирования конфигурационных файлов, логов и данных на удаленное хранилище (например, AWS или Google Cloud) с автоматическим расписанием.

### 4. Контроль версий конфигурационных файлов
- Использовать системы управления версиями по типу Git для хранения конфигурационных файлов. Это позволит отслеживать изменения и быстро восстанавливать предыдущие версии при ошибках.
